---
title: "Assessment"
author: "B273025"
date: "`r Sys.Date()`"
bibliography: "../zotero_citations.json"
link-citations: true
output: 
  html_document: 
    code_download: true
    toc: true
    theme: flatly

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache=FALSE)
```

# Emergency Contraceptive Pill and Sexually Transmitted Infections

Mark scheme:
Justified â€“ understanding of the data and their context  
Introduction  
Key results   
Conclusion 
References (for reason chosen research question)  
Narrative shows critical thinking  
Multiple data sources   
Recommendations and conclusions are grounded in the data  
Limitations of the data set discussed. Next steps suggested in terms of data that would allow for further analysis.   

## Introduction 

There are two types of emergency contraceptive pill prescribed by pharmacies.

>* **Levonogestrel** (brand name: *Levonelle*) taken within three days of unprotected sex
>* **Ulipristal Acetate** (brand name: *ellaOne*) taken within five days of unprotected sex  

STIs pose a  significant public health, with recent trends showing an increase in prevalence. 
The two most common sexually transmitted infections in Scotland are 
> * **chlamydia**, treated with *doxycylcine* or *azithromycin*  
> * **gonorrhea**, treated with *intramuscular ceftriaxone*.  


This report explores 

1) Prescribing patterns of emergency contraceptive pill (ECP) and antibiotics across 2023 (any time trends eg University return dates, festivals), considering if the prescription of ECP mirrors number of prescriptions of antibiotics used to treat STIs

2) How ECP and antibiotics for STI prescriptions differ in geography comparing university town to a non-university town 

3) Compare patterns in ECP and STI antibiotics prescribing during Covid-19 lockdowns - did the need for ECP or incidence of STI antibiotics prescription go down during lockdowns?

4) How does SIMD relate to prescription of ECP / antibiotics for STIs 

```{r}
library(tidyverse)
library(janitor) 
library(gt) 
library(here)
library(lubridate)
library(patchwork)
```

I have chosen to look at all prescriptions from 2020 and 2023. To do this I downloaded the prescriptions data for each month from: https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community  

I wanted to explore how many ECP and antibiotics for STIs were prescibed during across 2023.

## Key Results 


>4 plots and / or tables 
No use of settings other than default 
Labelled, titled plots 
Labelled titled tables 
Appropriate and thoughtful data visualisation with some use of non-default settings (gt)
Faceting, multilayered plots, interactive visualisation 

```{r}
#downloaded consecutive data for prescriptions for each month of 2020 and each month of 2023 and placed them into a folder named all_months_2020 and all_months_2023 respectively. I then combined these files into variables for all_prescriptions_2020 or all_prescriptions_2023.

all_files_2020 <- list.files(here("data","all_months_2020"), pattern = "csv")
all_prescriptions_2020 <- all_files_2020 %>% 
  map_dfr(~read_csv(here("data","all_months_2020", .))) %>% 
  clean_names()

all_files_2023 <- list.files(here("data","all_months_2023"), pattern = "csv")
all_prescriptions_2023 <- all_files_2023 %>% 
  map_dfr(~read_csv(here("data","all_months_2023", .),col_types = cols(DMDCode = col_character()))) %>% 
  clean_names()

#why did I need to use DMDCode col_character() here?

HB_names <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names()

#full_join to add health board name to the prescriptions dataset

all_prescriptions_2020 <- all_prescriptions_2020 %>% 
  full_join(HB_names, by = c("hbt" = "hb")) %>% 
  select(hb_name, hbt:paid_date_month)


all_prescriptions_2023 <- all_prescriptions_2023 %>% 
  full_join(HB_names, by = c("hbt" = "hb")) %>% 
  select(hb_name, hbt:paid_date_month)

# Data sets to consider exploring: 
#data_zones_2011 <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/395476ab-0720-4740-be07-ff4467141352/download/dz2011_codes_and_labels_21042020.csv") %>% 
  #clean_names()

#SIMD_2020 <- read_csv(here("data", "scottish-index-of-multiple-deprivation.csv")) %>%
  #clean_names()

#gp_addresses_2020 <- read_csv("https://www.opendata.nhs.scot/dataset/f23655c3-6e23-4103-a511-a80d998adb90/resource/42391720-7dcb-48a2-8070-b9d63b246ac6/download/practice_contactdetails_oct2020-open-data.csv") %>% 
  #clean_names() %>% 
  #select(practice_code, gp_practice_name, data_zone)

#data_zones <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/395476ab-0720-4740-be07-ff4467141352/download/dz2011_codes_and_labels_21042020.csv") %>% 
  #clean_names() %>% 
  #select(data_zone, data_zone_name)


# Use data from the most recent census to find the number of people in each health board 

population_data <- read_csv(here("data", "UV103_age_health_board_census.csv"), skip = 10) %>% 
  rename(Spare = "...6",
         hb_name = "Health Board Area 2019",
         hb_population = Count) %>% 
  filter(Age == "All people" & Sex == "All people") %>% 
  select(hb_name, hb_population) %>% 
  mutate(hb_name = paste("NHS", hb_name))

# join this to the 2023 prescriptions dataset 
all_prescriptions_2023 <- all_prescriptions_2023 %>% 
  full_join(population_data)

#initial exploration of dataset



ECP_per_head <- all_prescriptions_2023 %>% 
  drop_na()%>% 
  filter(str_detect(bnf_item_description, "LEVONO|ULIPR")) %>% 
  group_by(hb_name) %>% 
  summarise(quantity_per_head = sum(paid_quantity)/mean(hb_population))

ECP_per_head_chart <- ECP_per_head %>% 
  ggplot(aes(x = quantity_per_head, y = reorder(hb_name, quantity_per_head))) +
  geom_col() +
  labs(title = "Prescription of emergency contraceptive pills per person in each health board",
       x = "Quantity per head",
       y = "Health Board")
 
ECP_per_head_chart

prescriptions_2023 <- all_prescriptions_2023 %>% #each drug had different dosages and names so I used case_when() to group the drug names.
  mutate(
    month = parse_date_time(paid_date_month, "ym"),
    drug_simple = case_when(
      str_detect(bnf_item_description, "LEVONO") ~ "Levonorgestrel",
      str_detect(bnf_item_description, "ULIPR") ~ "Ulipristal",
      str_detect(bnf_item_description, "AZITHRO") ~ "Azithromycin",
      str_detect(bnf_item_description, "DOXY") ~ "Doxycycline",
      str_detect(bnf_item_description, "CEFTRI") ~ "Ceftriaxone",
      TRUE ~ "Other"),
    # categorised drug classes into emergency contraceptives and antibiotics
    category = if_else(drug_simple %in% c("Levonorgestrel", "Ulipristal"), "Emergency Contraceptives", "Antibiotics")) %>% 
  filter(drug_simple != "Other") %>%
  group_by(month, drug = drug_simple, category) %>%
  summarise(total_quantity = sum(paid_quantity, na.rm = TRUE))

prescriptions_2023_chart <- prescriptions_2023 %>% 
  ggplot(aes(x = month, y = total_quantity, color = drug)) +
  geom_line() +
  labs(
    title = "Monthly Prescription Counts for each drug",
    subtitle = "Separated into emergency conrtaception prescriptions and antibiotic prescriptions.",
    x = "Month in 2023",
    y = "Number of Prescriptions",
    color = "Drug"
  ) +
  theme_minimal() +
  facet_wrap(~category, ncol = 1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 10))
  #scale_x_date(date_labels = "%b %Y", date_breaks = "1 month")

prescriptions_2023_chart


#prescriptions of ECP are relatively tiny when compared to quantity of antibiotics prescribed - preventing observation of trends in ECP. Could use patchwork to present two separate ggplots 

ECP_plot <- prescriptions_2023 %>% 
  filter(category == "Emergency Contraceptives") %>% 
  ggplot(aes(x=month, y=total_quantity, colour = drug))+
  geom_line()+
  labs(
    title= "Monthly prescription counts for emergency contraceptive pills in 2023",
    x = "Months in 2023",
    y = "Number of prescriptions",
    colour = "Drug")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 10))

abx_plot <- prescriptions_2023 %>% 
  filter(category == "Antibiotics") %>% 
  ggplot(aes(x=month, y=total_quantity, colour = drug))+
  geom_line()+
  labs(
    title= "Monthly prescription counts for antibiotics in 2023",
    x = "Months in 2023",
    y = "Number of prescriptions",
    colour = "Drug"
  )+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 10))

#combine plots:

combined_ECP_abx_plot_2023 <- ECP_plot/abx_plot
combined_ECP_abx_plot_2023

# antibiotics prescriptions are not specific to STI. Is there a way of using age as a cut off for prescriptiosn? I don't think so as this isn't in the prescriptions database
# could i maybe make an assumption that 20% of prescriptions for abx are for STIs ?? if i find a reference
```

## Conclusion 

### Recommendations from analysis 

### Limitations of the dataset and suggestions for future analysis

antibiotics are prescribed for pneumonia / other infections. Not specific to STIs. Maybe find what percentage of antibiotics for doxy / azithro are prescribed for STIs in scotland and use this as an assumption when completing further analysis?



## References 
I used https://gsverhoeven.github.io/post/zotero-rmarkdown-csl/ to set up citations. Chosen BMJ style as common. 

